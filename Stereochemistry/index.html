<!DOCTYPE html><meta charset="utf-8"/>
<link rel="stylesheet" type="text/css" href="main.css"/>

<body>
	<div class="header">
		<p style="position: absolute;float: left;left: 25px;bottom: 17px;margin:0px; font-size: 24px;color: white;font-family: 'tradegothicltcom',sans-serif;font-weight: bold;text-shadow: 3px 4px 20px black;">School of Chemistry - Stereochemistry</p>

		<a href="http://www.leeds.ac.uk/"><img src="../unileeds.svg" alt="University of Leeds" style="position: relative;float: right;right: 20px;top: 22px;margin-bottom: 35px;width: 183px"/></a>
	</div>

	<div class="page">
		<div id="gameFrame">
			<div class="help" style="display:none"><p>?</p></div>
			<div class="view3D" style="width:1020px; height:431px;"></div>
			<div class="view2D" style="height:0px; "></div>

			<div class="menu" id="root" style="top: 431px;">
				<div style="left: 0px; top: 0px;">
					<h1>Revision Type</h1>
					<button class="button" onclick="MenuView( 'CIP' )" style="height: 53px;">Cahn - Ingold - Prelog</button>
					<button class="button" onclick="MenuView( 'Newman' )" style="height: 53px;float:right;">Newman Projections</button>
				</div>
				<div style="left: 1020px; top: -240px;">
					<h1>Cahn-Ingold-Prelog Rule</h1>
					<button class="button" onclick="MenuView( 'root' )" style="width:100px;float: left;height: 179px;">Back</button>
					<button class="button" onclick="cip = new CIP( 1 )" style="height: 53px;">Easy</button><br>
					<button class="button" onclick="cip = new CIP( 2 )" style="height: 53px;">Medium</button><br>
					<button class="button" onclick="cip = new CIP( 3 )" style="height: 53px;">Hard</button>
				</div>
				<div style="left: 2040px; top: -480px;">
					<h1>Newman Projections</h1>
					<button class="button" onclick="MenuView( 'root' )" style="width:100px;float: left;height: 179px;">Back</button>
					<div>
						<div style="float:left; width:49%;">
							<h1>3D/2D to Newman</h1>
							<button class="button" onclick="nm = new Newman( 1, 1 )" style="height: 53px; width: 100%;">Easy</button><br>
							<button class="button" onclick="nm = new Newman( 1, 2 )" style="height: 53px; width: 100%;">Hard</button><br>
						</div>
						<div style="float:left; width:49%;">
							<h1>Newman to 2D</h1>
							<button class="button" onclick="nm = new Newman( 2, 1 )" style="height: 53px; width: 100%;">Easy</button><br>
							<button class="button" onclick="nm = new Newman( 2, 2 )" style="height: 53px; width: 100%;">Hard</button><br>
						</div>
					</div>
				</div>
			</div>
			<div class="menu" id="CIPinputs" style="top: 431px;">
				<div class="head">
					<h1>Cahn-Ingold-Prelog Rule</h1>
				</div>
				<div class="inputs">
					<div id="CIPrank" style="float: left; width: 600px; height: 120px;"></div>
					<div id="CIPtoggles" style="float: right;width: 420px;">
						<label class="switch">
							<input type="checkbox">
							<span class="slider"></span>
							<h2 style="float: left;">Clockwise</h2>
							<h2 style="float: right;">Anticlockwise</h2>
						</label>
						<label class="switch">
							<input type="checkbox">
							<span class="slider"></span>
							<h2 style="float: left;">R</h2>
							<h2 style="float: right;">S</h2>
						</label>
					</div>
				</div>
				<div class="buttons">
					<button class="button" onclick="cip.closeGame()" style="width:100px;float: right;">Back</button>
					<button class="button" onclick="cip.init()" style="width:100px;float: right;">Skip</button>
					<button class="button" onclick="cip.submit()" style="width:100px;float: right;">Submit</button>
				</div>
			</div>
			<div class="menu" id="NMinputs" style="top: 431px;left: 235px;height: 350px;width: 550px;border: 6px solid #3e546b;">
				<div class="head">
					<h1>Newman Projection</h1>
				</div>
				<div class="inputs" style="width: 550px; height: 255px;">
				</div>
				<div class="buttons">
					<!-- <label style="position: absolute; top: 40px;"><input type="checkbox" onchange="nm.orient( this.checked )"/>Staggered/Eclipse</label> -->
					<button class="button" onclick="nm.closeGame()" style="width:100px;float: right;">Back</button>
					<button class="button" onclick="nm.init( true )" style="width:100px;float: right;">Skip</button>
					<button class="button" onclick="nm.submit()" style="width:100px;float: right;">Submit</button>
				</div>
			</div>
		</div>
	</div>

	<script src="https://d3js.org/d3.v4.min.js"></script>
	<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
	<script src="https://www.lactame.com/lib/openchemlib/5.4.0/openchemlib-minimal.js"></script>

	<script src="three.min.js"></script>
	<script src="stats.min.js"></script>
	<script src="Detector.js"></script>
	<script src="TrackballControls.js"></script>
	<script src="OutlineEffect.js"></script>
	<script src="molViewer.js"></script>

	<script>


	var intromolfile = `C10H12N2O
APtclcactv03021811533D 0   0.00000     0.00000

 25 26  0  0  0  0  0  0  0  0999 V2000
   -2.9412    0.0426    0.2708 C   0  0  0  0  0  0  0  0  0  0  0  0
   -2.3564   -1.2023    0.3322 C   0  0  0  0  0  0  0  0  0  0  0  0
   -0.9908   -1.3410    0.1065 C   0  0  0  0  0  0  0  0  0  0  0  0
   -0.2173   -0.2031   -0.1836 C   0  0  0  0  0  0  0  0  0  0  0  0
   -0.8213    1.0549   -0.2437 C   0  0  0  0  0  0  0  0  0  0  0  0
   -2.1779    1.1716   -0.0163 C   0  0  0  0  0  0  0  0  0  0  0  0
   -2.7714    2.3937   -0.0736 O   0  0  0  0  0  0  0  0  0  0  0  0
    1.1554   -0.6813   -0.3648 C   0  0  0  0  0  0  0  0  0  0  0  0
    1.1354   -2.0113   -0.1836 C   0  0  0  0  0  0  0  0  0  0  0  0
   -0.1378   -2.4245    0.0989 N   0  0  0  0  0  0  0  0  0  0  0  0
    2.3616    0.1603   -0.6930 C   0  0  0  0  0  0  0  0  0  0  0  0
    2.9483    0.7359    0.5975 C   0  0  0  0  0  0  0  0  0  0  0  0
    4.1241    1.5564    0.2775 N   0  0  0  0  0  0  0  0  0  0  0  0
   -4.0026    0.1441    0.4424 H   0  0  0  0  0  0  0  0  0  0  0  0
   -2.9577   -2.0710    0.5560 H   0  0  0  0  0  0  0  0  0  0  0  0
   -0.2304    1.9311   -0.4661 H   0  0  0  0  0  0  0  0  0  0  0  0
   -3.0553    2.5240   -0.9887 H   0  0  0  0  0  0  0  0  0  0  0  0
    1.9968   -2.6593   -0.2512 H   0  0  0  0  0  0  0  0  0  0  0  0
   -0.4011   -3.3424    0.2690 H   0  0  0  0  0  0  0  0  0  0  0  0
    3.1109   -0.4565   -1.1893 H   0  0  0  0  0  0  0  0  0  0  0  0
    2.0669    0.9758   -1.3535 H   0  0  0  0  0  0  0  0  0  0  0  0
    2.1991    1.3527    1.0937 H   0  0  0  0  0  0  0  0  0  0  0  0
    3.2431   -0.0795    1.2580 H   0  0  0  0  0  0  0  0  0  0  0  0
    4.4758    1.9131    1.1534 H   0  0  0  0  0  0  0  0  0  0  0  0
    4.8267    0.9281   -0.0827 H   0  0  0  0  0  0  0  0  0  0  0  0
  1  2  2  0  0  0  0
  2  3  1  0  0  0  0
  3  4  2  0  0  0  0
  4  5  1  0  0  0  0
  5  6  2  0  0  0  0
  1  6  1  0  0  0  0
  6  7  1  0  0  0  0
  4  8  1  0  0  0  0
  8  9  2  0  0  0  0
  9 10  1  0  0  0  0
  3 10  1  0  0  0  0
  8 11  1  0  0  0  0
 11 12  1  0  0  0  0
 12 13  1  0  0  0  0
  1 14  1  0  0  0  0
  2 15  1  0  0  0  0
  5 16  1  0  0  0  0
  7 17  1  0  0  0  0
  9 18  1  0  0  0  0
 10 19  1  0  0  0  0
 11 20  1  0  0  0  0
 11 21  1  0  0  0  0
 12 22  1  0  0  0  0
 12 23  1  0  0  0  0
 13 24  1  0  0  0  0
 13 25  1  0  0  0  0
M  END
$$$$
	`

	var mol3d = new Mol3D( d3.select( "#gameFrame > .view3D" ), {disableInteractions: true, showfGroups: false, highlight: false, autoRotate: true} );
	var mol2d = new Mol2D( d3.select( "#gameFrame > .view2D"), [0,0,480,321] );
	var mouseover = function(){};
	var mouseout = function(){};

	d3.csv( "data.csv", ( data ) => {d = data} )

	mol3d.parse( intromolfile )
	mol3d.draw()

	function MenuView( state ){

		const w = 1020;
		var states = {
			root: [0, w, 2*w],
			CIP: [-w, 0, w],
			Newman: [-2*w, -w, 0],
		};

		d3.select( "#gameFrame > #root > :nth-child(1)" ).transition()
			.duration(1000)
			.ease(d3.easeBackInOut)
			.style( "left", states[state][0] + "px")

		d3.select( "#gameFrame > #root > :nth-child(2)" ).transition()
			.duration(1000)
			.ease(d3.easeBackInOut)
			.style( "left", states[state][1] + "px")

		d3.select( "#gameFrame > #root > :nth-child(3)" ).transition()
			.duration(1000)
			.ease(d3.easeBackInOut)
			.style( "left", states[state][2] + "px")
	}

	CIP = function( diff ){
		var self = this;
		self.diff = diff;
		self.labels = [];
		mol3d.interactions( true );
		mol3d.autoRotate( false );
		mol3d.highlightSync( true );
		mol3d.highlight( true );

		self.reset = function(){

			//////Reset game to original state//////
			mol3d.container.removeEventListener( "mouseover", self.mouseover);
			mol3d.container.removeEventListener( "mouseout", self.mouseout);
			mol2d.svg && mol2d.svg.remove();
			while( self.labels.length > 0 ){ self.labels.pop( 0 ).remove() };
			d3.select( "#rootframe" ).html( "" );
			d3.selectAll( "#CIPtoggles > label > span" ).style( "fill", null ).style( "background-color", null );
			d3.selectAll( "#CIPtoggles > label > input" ).each( function(){ this.checked = false; } );
			d3.select( "#CIPinputs > .buttons > :nth-child(2)" ).html( "Skip" ).style( "background-color", null );
			d3.select( ".resultRight" ).remove()
			d3.select( "#molName" ).remove()

			d3.select( "#CIPrank" ).html(
				`<svg class="dd" id="CIPdragdrop" viewBox="0,0,600,120">
					<defs>
						<mask id="first">
							<rect  width="100%" height="100%" fill="#fff"/>
							<text x="110" y="42" fill="#b5b5b5">1st</text>
						</mask>
						<mask id="second">
							<rect  width="100%" height="100%" fill="#fff"/>
							<text x="235" y="42" fill="#b5b5b5">2nd</text>
						</mask>
						<mask id="third">
							<rect  width="100%" height="100%" fill="#fff"/>
							<text x="360" y="42" fill="#b5b5b5">3rd</text>
						</mask>
						<mask id="fourth">
							<rect  width="100%" height="100%" fill="#fff"/>
							<text x="485" y="42" fill="#b5b5b5">4th</text>
						</mask>
					</defs>
					<rect id="dd1_TAR" x="60" y="5" width="100" height="50" mask="url('#first')"></rect>
					<rect id="dd2_TAR" x="185" y="5" width="100" height="50" mask="url('#second')"></rect>
					<rect id="dd3_TAR" x="310" y="5" width="100" height="50" mask="url('#third')"></rect>
					<rect id="dd4_TAR" x="435" y="5" width="100" height="50" mask="url('#fourth')"></rect>
					<text id="dd1" x="110" y="100"></text>
					<text id="dd2" x="235" y="100"></text>
					<text id="dd4" x="485" y="100"></text>
					<text id="dd3" x="360" y="100"></text>
				</svg>`
			);

			d3.selectAll( "#CIPdragdrop > text" ).on( "mousedown touchstart", function(){dragLabel( this )} );
		}

		self.init = function(){

			self.reset();
			d3.select( ".help" )
				.style( "display", null )
				.on( "mouseover", function(){
					d3.select( this )
						.html( "Your job is to rank the atoms surrounding the target atom (highlighted in orange). From there, you can find the handedness of the molecule.")
						.style( "width", "200px")
						.style( "height", "200px")
						.on( "mouseout", function(){
							d3.select( this )
								.html( "?" )
								.style( "width", null )
								.style( "height", null )
						});
				});

			//////Frame positioning//////
			d3.transition()
				.duration( 1500 )
				.tween( null, function(){ return function( t ){mol3d.scene.traverse( obj => {obj instanceof THREE.Mesh && obj.scale.set( 1-t, 1-t, 1-t )} )} } )
				.on( "end", () => {
					mol3d.scene.remove( mol3d.molGroup );
					self.runGame( self.diff );
					d3.selectAll( "#gameFrame > .view3D, #gameFrame > .view2D" )
						.style( "width", "480px" )
						.style( "height", "431px" )
					mol2d.onWindowResize();
					mol2d.fitToScreen();
					mol3d.onWindowResize();
				} )

			d3.select( "#gameFrame > #root" )
				.transition()
				.duration( 1500 )
				.ease( d3.easePolyInOut )
				.style( "top", "677px" )
			d3.select( "#gameFrame > #CIPinputs" )
				.transition()
				.duration( 1500 )
				.ease( d3.easePolyInOut )
				.style( "top", "184.5px")
		};

		self.runGame = function( ){
			var filtered = self.diff === 3 ? d.filter( el => +el.CIPLvl !== "" ) : d.filter( el => +el.CIPLvl === ( self.diff === 1 ? 1 : 2 ) )
			self.answer = filtered[Math.floor( Math.random() * filtered.length)];

			mol2d.parse( self.answer.Data2D );
			mol3d.parse( self.answer.Data3D );

			d3.select( "#view2d" )
			mol2d.draw();

			mol2d.onWindowResize();
			mol3d.draw( true );

			//////Hide standard Hydrogens//////
			mol2d.molecule.atoms.map( el => {
				if( el.element === "H" ){
					var grp = d3.select( "[id='" + el.index + "']")
					if( grp.node().parentNode.parentNode.getAttribute( "class" ).split( "_" )[1] === "C" && grp.node().previousSibling.getAttribute( "class" ) === "bond" ){
						grp.attr( "display", "none" )
						d3.select( grp.node().previousSibling ).attr( "display", "none" )
					}
				}
			})

			//////Add molecule name//////
			d3.select( mol3d.container ).append( "p" ).attr( "id", "molName" ).text( self.answer.Name.split( "-" ).slice( -1 ) )

			//////Create labels for adjacent atoms//////
			mol3d.scene.getObjectByName( +self.answer.CIPRoot ).userData.source.bondedTo.forEach( function( el, i ){
				if( self.diff !== 3 ){
					var label = d3.select( ".view3D" ).append( "p" )
						.html( el.el.index )
						.attr( "class", "label" )
					self.labels.push( label )
				}

				var grp = d3.select( "[id='" + el.el.index + "']")
				if( grp.attr( "class" ).split( "_" )[1] === "H" ){
					grp.attr( "display", null )
					grp.node().previousSibling.setAttribute( "display", null )
				}

				d3.select( "#CIPdragdrop > #dd" + ( i + 1 ) ).text( el.el.element + "-" + el.el.index );
				d3.select( "#atomind_" + el.el.index ).attr( "display", null );
			});

			//////Attach labels to atoms in 3d//////
			mol3d.frameFunctions.labelPos = {
				enabled: true,
				fn: function(){
						var widthHalf = mol3d.container.getBoundingClientRect().width/2;
						var heightHalf = mol3d.container.getBoundingClientRect().height/2;
						for( label of self.labels ){
							var vector = new THREE.Vector3().setFromMatrixPosition( mol3d.scene.getObjectByName( +label.html() ).matrixWorld );
							vector.project( mol3d.camActive );

							label.style("right", ( - ( vector.x * widthHalf ) + widthHalf ) + "px" )
							label.style("bottom", ( ( vector.y * heightHalf ) + heightHalf ) + "px" )
						}
					}
			};

			//////Highlight svg atom//////
			var rootAtom2D = d3.select( "#highlight_"+ self.answer.CIPRoot );
			mol2d.root.node().insertBefore( d3.select( rootAtom2D.node().cloneNode() ).attr( "r", 8 ).attr( "class", "atomFocus").attr( "id", null ).node(), mol2d.root.node().childNodes[0] );

			//////Highlight 3D atom//////
			var rootAtom3D =  mol3d.scene.getObjectByName( +self.answer.CIPRoot );
			rootAtom3D.geometry.scale( 1.5, 1.5, 1.5 );
			rootAtom3D.material.color.set( new THREE.Color().setRGB( 1, 0.5, 0 ) );

			//////Orient molecule//////
			var objUp = new THREE.Vector3().copy( mol3d.scene.getObjectByName( rootAtom3D.userData.source.bondedTo[0].el.index ).position ).sub( rootAtom3D.position ).normalize();
			mol3d.molGroup.rotateOnAxis( new THREE.Vector3().crossVectors( objUp, new THREE.Vector3( 0, 1, 0 ) ).normalize() , objUp.angleTo( new THREE.Vector3(0,1,0)) );

			//////Fade non-essential atoms//////
			var essentials = [ rootAtom3D ];
			rootAtom3D.userData.source.bondedTo.forEach( el => {
				essentials.push( mol3d.scene.getObjectByName( el.el.index ) );
				essentials.push( mol3d.scene.getObjectByName( el.bond.start.index + "_" + el.bond.end.index ) );
			} );
			mol3d.molGroup.traverse( obj => { if( obj instanceof THREE.Mesh && obj.userData.type !== "fGroup" ){
					obj.scale.set( 0.01, 0.01, 0.01 );
					obj.visible = true;
					if( essentials.indexOf( obj ) === -1 ){
						obj.material.transparent = true;
						obj.material.opacity = 0.2;
					}
				}
			} );

			self.mouseover = function() {
						mol3d.molGroup.traverse( obj => {
							if( obj instanceof THREE.Mesh && essentials.indexOf( obj ) === -1 ){
								obj.material.opacity = 1;
							}
						})
					};

			self.mouseout = function() {
					mol3d.molGroup.traverse( obj => {
						if( obj instanceof THREE.Mesh && essentials.indexOf( obj ) === -1 ){
							obj.material.opacity = 0.2;
						}
					})
				};

			mol3d.container.addEventListener( "mouseover", self.mouseover );
			mol3d.container.addEventListener( "mouseout", self.mouseout );

			//////Focus Camera on atom//////
			var controlsStart = mol3d.controls.target;
			d3.transition()
				.duration( 2000 )
				.tween( null, () => function( t ){
					mol3d.molGroup.traverse( obj => obj.scale.set( t, t, t ) )
					mol3d.controls.target.copy( new THREE.Vector3( ).copy( controlsStart ).lerp( new THREE.Vector3( ).copy( rootAtom3D.getWorldPosition() ), t ) );
					mol3d.camActive.up.copy( new THREE.Vector3( ).copy( mol3d.camActive.up ).lerp( new THREE.Vector3( 0, 1, 0 ), t ) )
				} )
				.on( "end", function(){
				//////Hide 3D view on hardest difficulty//////
					if( self.diff === 3 && d3.select( ".Blocker3D" ).empty() ){
						mol3d.mouse = new THREE.Vector2(1,1)
						var svg = d3.select( mol3d.container ).append( "svg" ).attr( "class", "Blocker3D" ).attr( "style", "width: 100%; height: 100%; position: absolute; left: 0px; top: 0px;");
						svg.append( "rect" ).attr( "x", 0 ).attr( "y", 0 ).attr( "width", "50%" ).attr( "height", "100%" ).attr( "transform", "translate( -240, 0 )");
						svg.append( "rect" ).attr( "x", "50%" ).attr( "y", 0 ).attr( "width", "50%" ).attr( "height", "100%" ).attr( "transform", "translate( 240, 0 )");

						d3.selectAll( ".Blocker3D > rect" ).transition()
							.duration( 1000 )
							.ease( d3.easeBounceOut )
							.attr( "transform", "translate( 0, 0 )")
							.on( "end", () => svg.append( "text" ).attr( "x", 240 ).attr( "y", 215 ).attr( "text-anchor", "middle" ).text( "No 3D on this difficulty!" ) )
					}
				} )

		}

		self.closeGame = function(){

			self.reset()
			d3.select( ".help" )

			//////Hide 3D View Blocker//////
			d3.select( ".Blocker3D > :nth-child(1)" ).transition()
				.duration( 1000 )
				.attr( "transform", "scale( 0, 1 )" )
			d3.select( ".Blocker3D > :nth-child(2)" ).transition()
				.duration( 1000 )
				.attr( "transform", "translate( 480, 0 ) scale( 0, 1 )" )
				.on( "end", () => d3.select( ".Blocker3D" ).remove() )

			d3.transition()
				.duration( 1500 )
				.tween( null, function(){ return function( t ){ mol3d.controls.target.lerp( new THREE.Vector3( 0, 0, 0 ), t ) } })

				mol3d.molGroup.traverse( obj => {
					if( obj instanceof THREE.Mesh ){
						obj.material.opacity = 1;
					}
				})

			mol3d.interactions( false );
			mol3d.autoRotate( true );
			mol3d.highlightSync( false );
			mol3d.highlight( false );

			//////FRAME REPOSITIONING//////
			d3.selectAll( ".view2D" )
				.transition()
				.duration( 1500 )
				.style( "width", "0px" )
				.style( "height", "0px" )
			d3.select( ".view3D" )
				.transition()
				.duration( 1500 )
				.style( "width", "1020px" )
				.tween( null, function(){return function( t ){ mol3d.onWindowResize() } })
			d3.selectAll( ".menu" )
				.transition()
				.duration( 1000 )
				.ease( d3.easePolyInOut )
				.style( "top", "431px" )
			//////----------//////
		}

		self.submit = function(){
			var correct = true;

			d3.selectAll( "#CIPdragdrop > text" ).each( function( rank, i ){
				var bg = d3.select( "#dd" + rank + "_TAR")
				correct = correct ? self.answer.CIPRanks.split( "," )[ rank - 1 ] === this.innerHTML.split( "-" )[1] : false
				elFlash( bg, ( self.answer.CIPRanks.split( "," )[ rank - 1 ] === this.innerHTML.split( "-" )[1] ) )
			} )

			d3.selectAll( "#CIPtoggles > label > input" ).each( ( d, i, arr ) => {
				var bg = d3.select( arr[i].nextElementSibling )
				correct = correct ? arr[i].checked === ( self.answer['CIPr/s'] === "r" ? false : true ) : false
				elFlash( bg, correct );
			})

			if( correct ){
				d3.select( "#CIPinputs > .buttons > :nth-child(2)" ).transition()
					.delay( 300 )
					.duration( 300 )
					.style( "transform", "scale( 1.5 )" )
					.style( "background-color", "#4caf50" )
					.on( "end", function(){
						this.innerHTML = "Next";
						this.setAttribute( "onclick", "cip.init()" )
					} )
					.transition()
						.style( "transform", "scale( 1 )")
				d3.select( "#CIPinputs > .buttons > p" ).empty() && d3.select( "#CIPinputs > .buttons" ).append( "p" ).attr( "class", "resultRight" ).html( "That's right!" )
			}

		}

		self.init()
	}

	function elFlash( el, correct ){
		if( correct ){
			el.transition()
				.duration( 200 )
				.style( "fill", "#4CAF50" )
				.style( "background-color", "#4CAF50" )
		} else{
			el.transition()
				.duration( 200 )
				.style( "fill", "red" )
				.style( "background-color", "red" )
				.on( "end", () => {
					el.transition()
						.duration( 800 )
						.style( "fill", "lightgray" )
						.style( "background-color", "#5b7da0" )
				})
		}

	}

	function shuffle(array) {
	  var arr = [...array];
	  var currentIndex = array.length, temporaryValue, randomIndex;
	  while ( 0 !== currentIndex ) {
		randomIndex = Math.floor( Math.random() * currentIndex );
		currentIndex -= 1;
		temporaryValue = arr[currentIndex];
		arr[currentIndex] = arr[randomIndex];
		arr[randomIndex] = temporaryValue;
	  }
	  return arr;
	}

	Newman = function( mode ){
		var self = this;
		var pathway, groups, answer;
		self.mode = mode;
		self.labels = [];
		mol3d.interactions( true );
		mol3d.autoRotate( false );
		mol3d.highlightSync( true );
		mol3d.highlight( true );

		self.reset = function(){
			//////Reset game to original state//////
			mol2d.svg && mol2d.svg.remove();
			mol3d.scene.remove( mol3d.molGroup );

			while( self.labels.length > 0 ){ self.labels.pop( 0 ).remove() }
			//d3.select( "#NMinputs > .buttons > label > input" ).node().checked = false;
			d3.select( "#rootframe" ).html( "" );
			d3.select( "#NMResult" ).remove();

			if( self.mode === 1 ){
				d3.select( "#NMinputs > .inputs").html(`
					<svg class="dd" id="NMdragdrop" viewBox="0,0,550,255">
						<g id="NMbonds" transform="translate( 275, 127.5 )rotate( 0 )">
							<rect x="-87" y="-100" width="174" height="200" style="stroke:none; opacity:0;"></rect>
							<circle cx="0" cy="0" r="50" style="stroke:black; fill:none;"></circle>
							<line x1="0" y1="0" x2="0" y2="-100"></line>
							<line x1="0" y1="0" x2="87" y2="50"></line>
							<line x1="0" y1="0" x2="-87" y2="50"></line>
							<line x1="43" y1="-25" x2="87" y2="-50"></line>
							<line x1="0" y1="50" x2="0" y2="100"></line>
							<line x1="-43" y1="-25" x2="-87" y2="-50"></line>
						</g>
						<rect id="dd1_TAR" x="235" y="5" width="80" height="40"></rect>
						<rect id="dd2_TAR" x="321" y="55" width="80" height="40"></rect>
						<rect id="dd3_TAR" x="322" y="155" width="80" height="40"></rect>
						<rect id="dd4_TAR" x="235" y="205" width="80" height="40"></rect>
						<rect id="dd5_TAR" x="148" y="155" width="80" height="40"></rect>
						<rect id="dd6_TAR" x="148" y="55" width="80" height="40"></rect>
						<text id="dd1" x="85" y="75"></text>
						<text id="dd2" x="85" y="150"></text>
						<text id="dd3" x="85" y="225"></text>
						<text id="dd4" x="465" y="75"></text>
						<text id="dd5" x="465" y="150"></text>
						<text id="dd6" x="465" y="225"></text>
					</svg>`
				)
			} else{
				d3.select( "#NMinputs > .inputs").html(`
					<svg class="dd" id="NMdragdrop" viewBox="0 0 550 255">
						<g id="rootframe" transform="translate(-15,-30)scale(2)rotate(30)">
							<g class="bond_wedge" display="null">
								<rect x="-8" y="-7.5" rx="7.5" ry="7.5" width="40.798761581982276" height="15" transform="translate(183.92399999999998,-10)rotate(-30.001651972785513)" class="highlight" id="highlight_1_0"></rect>
								<polygon id="" points="183.92399999999998,-10 199.97,-15.80 196.97,-21.00"></polygon>
							</g>
							<g class="bond_wedge" display="null">
								<rect x="-8" y="-7.5" rx="7.5" ry="7.5" width="40.798761581982276" height="15" transform="translate(149.284,10)rotate(30.001651972785513)" class="highlight" id="highlight_4_5"></rect>
								<polygon id="" points="149.284,10 162.33,21.00 165.33,15.80"></polygon>
							</g>
							<g class="bond">
								<line id="" x1="183.92399999999998" x2="218.56400000000002" y1="-10" y2="10"></line>
							</g>
							<g class="bond_hash">
								<line class="bond" x1="183.92" x2="183.92" y1="-10.00" y2="-10.00"></line>
								<line class="bond" x1="184.21" x2="183.64" y1="-13.00" y2="-13.00"></line>
								<line class="bond" x1="184.49" x2="183.36" y1="-16.00" y2="-16.00"></line>
								<line class="bond" x1="184.77" x2="183.08" y1="-19.00" y2="-19.00"></line>
								<line class="bond" x1="185.05" x2="182.80" y1="-22.00" y2="-22.00"></line>
								<line class="bond" x1="185.33" x2="182.52" y1="-25.00" y2="-25.00"></line>
								<line class="bond" x1="185.61" x2="182.24" y1="-28.00" y2="-28.00"></line>
								<line class="bond" x1="185.89" x2="181.96" y1="-31.00" y2="-31.00"></line>
								<line class="bond" x1="186.17" x2="181.67" y1="-34.00" y2="-34.00"></line>
								<line class="bond" x1="186.46" x2="181.39" y1="-37.00" y2="-37.00"></line>
								<line class="bond" x1="186.74" x2="181.11" y1="-40.00" y2="-40.00"></line>
							</g>
							<g class="bond">
								<line id="" x1="183.92399999999998" x2="149.284" y1="-10" y2="10"></line>
							</g>
							<g class="bond_hash">
								<line class="bond" x1="149.28" x2="149.28" y1="10.00" y2="10.00"></line>
								<line class="bond" x1="149.00" x2="149.57" y1="13.00" y2="13.00"></line>
								<line class="bond" x1="148.72" x2="149.85" y1="16.00" y2="16.00"></line>
								<line class="bond" x1="148.44" x2="150.13" y1="19.00" y2="19.00"></line>
								<line class="bond" x1="148.16" x2="150.41" y1="22.00" y2="22.00"></line>
								<line class="bond" x1="147.88" x2="150.69" y1="25.00" y2="25.00"></line>
								<line class="bond" x1="147.60" x2="150.97" y1="28.00" y2="28.00"></line>
								<line class="bond" x1="147.32" x2="151.25" y1="31.00" y2="31.00"></line>
								<line class="bond" x1="147.03" x2="151.53" y1="34.00" y2="34.00"></line>
								<line class="bond" x1="146.75" x2="151.82" y1="37.00" y2="37.00"></line>
								<line class="bond" x1="146.47" x2="152.10" y1="40.00" y2="40.00"></line>
							</g>
							<g class="bond">
								<line id="" x1="149.284" x2="114.64" y1="10" y2="-10"></line>
							</g>
						</g>
						<rect id="dd1_TAR" x="105" y="40" width="80" height="40"></rect>
						<rect id="dd2_TAR" x="330" y="35" width="80" height="40"></rect>
						<rect id="dd3_TAR" x="140" y="195" width="80" height="40"></rect>
						<rect id="dd4_TAR" x="360" y="190" width="80" height="40"></rect>
						<rect id="dd5_TAR" x="240" y="175" width="80" height="40"></rect>
						<rect id="dd6_TAR" x="355" y="116" width="80" height="40"></rect>
						<text id="dd1" x="60" y="75"></text>
						<text id="dd2" x="60" y="150"></text>
						<text id="dd3" x="60" y="225"></text>
						<text id="dd4" x="490" y="75"></text>
						<text id="dd5" x="490" y="150"></text>
						<text id="dd6" x="490" y="225"></text>
					</svg>
					`
				)
			}

			d3.selectAll( "#NMdragdrop > text" ).on( "mousedown touchstart", function(){dragLabel( this )} );
			d3.select( "#NMinputs > .buttons > :nth-child(2)" ).html( "Skip" ).style( "background-color", null );
			d3.select( ".resultRight" ).remove()
		}

		self.init = function( refresh ){

			self.reset();

			groups = shuffle( ["Me","Et","Ph","OH","H",["Cl","Br","F"][Math.floor( Math.random() * 3 )]] );
			pathway = Math.floor( Math.random() * 4 ) + 1

			if( refresh ){
				if( self.mode === 1 ){
					self.runGame1()
				} else{
					self.runGame2()
				}
			} else{
				d3.transition()
					.duration( 1500 )
					.tween( null, function(){ return function( t ){mol3d.scene.traverse( obj => {obj instanceof THREE.Mesh && obj.scale.set( 1-t, 1-t, 1-t )} )} } )
					.on( "end", () => {

						mol3d.scene.remove( mol3d.molGroup );
						d3.selectAll( "#gameFrame > .view3D, #gameFrame > .view2D" )
							.style( "width", "480px" )
							.style( "height", "321px" )
						mol3d.onWindowResize();

						if( self.mode === 1 ){
							self.runGame1()
						} else{
							self.runGame2()
						}

					} )

				d3.select( "#gameFrame > #root" )
					.transition()
					.duration( 1500 )
					.ease( d3.easePolyInOut )
					.style( "top", "677px" )
				d3.select( "#gameFrame > #NMinputs" )
					.transition()
					.duration( 1500 )
					.ease( d3.easePolyInOut )
					.style( "top", "-171px")
				}
		}

		self.runGame1 = function(){

			console.log( pathway )
			shuffle( groups ).forEach( ( el, i ) => d3.select( "#NMdragdrop > #dd" + ( i + 1 ) ).text( el ) );

			var templateMol2D = [2,3].indexOf( pathway ) !== -1 ? `
APtclcactv04271809452D 0   0.00000     0.00000

 8  7   0  0  1  0  0  0  0  0999 V2000
    5.3350    0.7600    0.0000 ` + groups[( pathway === 2 ? 1 : 5 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
    4.5981    0.2500    0.0000 C   0  0  1  0  0  0  0  0  0  0  0  0
    5.4641   -0.2500    0.0000 ` + groups[( pathway === 2 ? 3 : 3 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
    4.5981    1.2500    0.0000 ` + groups[( pathway === 2 ? 5 : 1 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
    3.7321   -0.2500    0.0000 C   0  0  2  0  0  0  0  0  0  0  0  0
    4.3690   -0.6600    0.0000 ` + groups[( pathway === 2 ? 2 : 4 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
    3.7321   -1.2500    0.0000 ` + groups[( pathway === 2 ? 4 : 2 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
    2.8660    0.2500    0.0000 ` + groups[( pathway === 2 ? 0 : 0 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
  2  1  1  1  0  0  0
  2  3  1  0  0  0  0
  2  4  1  6  0  0  0
  2  5  1  0  0  0  0
  5  6  1  1  0  0  0
  5  7  1  6  0  0  0
  5  8  1  0  0  0  0
M  END
$$$$
` : `
APtclcactv04271809452D 0   0.00000     0.00000

8  7   0  0  1  0  0  0  0  0999 V2000
	5.3350    0.7600    0.0000 ` + groups[( pathway === 1 ? 2 : 4 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
	4.5981    0.2500    0.0000 C   0  0  1  0  0  0  0  0  0  0  0  0
	5.4641   -0.2500    0.0000 ` + groups[( pathway === 1 ? 4 : 2 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
	4.5981    1.2500    0.0000 ` + groups[( pathway === 1 ? 0 : 0 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
	3.7321   -0.2500    0.0000 C   0  0  2  0  0  0  0  0  0  0  0  0
	4.0000    0.5000    0.0000 ` + groups[( pathway === 1 ? 5 : 1 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
	3.7321   -1.2500    0.0000 ` + groups[( pathway === 1 ? 3 : 3 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
	2.8660    0.2500    0.0000 ` + groups[( pathway === 1 ? 1 : 5 )] + `   0  0  0  0  0  0  0  0  0  0  0  0
  2  1  1  6  0  0  0
  2  3  1  1  0  0  0
  2  4  1  0  0  0  0
  2  5  1  0  0  0  0
  5  6  1  1  0  0  0
  5  7  1  0  0  0  0
  5  8  1  6  0  0  0
M  END
$$$$
`

		var templateMol3D = `
APtclcactv04271809453D 0   0.00000     0.00000

 8  7   0  0  1  0  0  0  0  0999 V2000
    0.4892    0.0420   -2.0506 ` + groups[1] + `   0  0  0  0  0  0  0  0  0  0  0  0
    0.3143    0.4552   -1.0572 C   0  0  1  0  0  0  0  0  0  0  0  0
    0.6266    1.9530   -1.0655 ` + groups[3] + `  0  0  0  0  0  0  0  0  0  0  0  0
    1.4785   -0.4498    0.2432 ` + groups[5] + `  0  0  0  0  0  0  0  0  0  0  0  0
   -1.1495    0.2416   -0.6664 C   0  0  2  0  0  0  0  0  0  0  0  0
   -1.7962    0.6667   -1.4340 ` + groups[2] + `   0  0  0  0  0  0  0  0  0  0  0  0
   -1.4750    1.0527    0.9106 ` + groups[4] + `   0  0  0  0  0  0  0  0  0  0  0  0
   -1.4292   -1.2570   -0.5365 ` + groups[0] + `   0  0  0  0  0  0  0  0  0  0  0  0
  1  2  1  0  0  0  0
  2  3  1  0  0  0  0
  2  4  1  0  0  0  0
  2  5  1  0  0  0  0
  5  6  1  0  0  0  0
  5  7  1  0  0  0  0
  5  8  1  0  0  0  0
M  END
$$$$
`

			mol2d.parse( templateMol2D );
			mol3d.parse( templateMol3D );
			mol3d.draw( false );
			mol2d.draw();
			mol2d.showH( true )
			mol2d.onWindowResize();
			mol2d.fitToScreen();

			//////Give 2 answers//////
			var ans1 = Math.floor( Math.random() * 6 );
			var ans2 = Math.floor( Math.random() * 6 );
			console.log( ans1, ans2 )
			while( ans2 === ans1 || [0,3].indexOf( ans2 ) !== -1 ){
				ans2 = Math.floor( Math.random() * 6 );
			}

			[ans1, ans2].forEach( el => {
				d3.selectAll( "#NMdragdrop > text" ).each( function(){
					if( this.innerHTML === groups[el] ){
						var tarNode = d3.select( "#NMdragdrop > #dd" + ( el + 1 ) + "_TAR" ).node()

						d3.select( tarNode ).attr( "disabled", true);
						d3.select( this ).attr( "disabled", true).attr( "pointer-events", "none" ).attr( "fill", "dimgrey" );

						d3.select( this )
							.attr( "x", +tarNode.getAttribute( "x" ) + tarNode.getBoundingClientRect().width/2 )
							.attr( "y", +tarNode.getAttribute( "y" ) + tarNode.getBoundingClientRect().height/2 + 13 )
							.datum( tarNode.getAttribute( "id" ).substr( 2, 1 ) )
					}
				})
			})

			//////Highlight svg atom//////
			d3.select( document.querySelector( "#highlight_1_4" ).nextElementSibling ).style( "stroke", "orange" )


			//////Highlight 3D atom//////
			mol3d.scene.getObjectByName( "1_4" ).material.color.set( new THREE.Color().setRGB( 1, 0.5, 0 ) );

			//////Draw eye on 2D view//////
			d3.select( "#NMdragdrop" )
				.append( "g" )
				.attr( "class", "eye" )
				.html(`
					<rect x="-140" y="-20" width="140" height="40" style="stroke:none; opacity:0;"></rect>
					<line x1="-140" x2="-120" y1="0" y2="20"></line>
					<line x1="-140" x2="-120" y1="0" y2="-20"></line>
					<path d="M -128 -12 Q -120 0 -128 12"></path>
					<line x1="-124" x2="-50" y1="0" y2="0" opacity="0.3" style="stroke-dasharray: 10px;"></line>
					`)
				.attr( "transform", "translate( 275, 127.5 )scale( 1, 1 )")

			//////Mouseover/Mousedown Animations//////
			var eyeLeft = true;
			var rotated = false;

			d3.select( ".eye" )
				.on( "mouseover", function(){
					d3.select( this )
						.transition()
						.duration( 500 )
						.ease( d3.easeBackOut )
						.attr( "transform", "translate( 275, 127.5)scale( " + ( eyeLeft ? 0.75 : -0.75 ) + ", 1 )")
				})
				.on( "mouseout", function(){
					d3.select( this )
						.transition()
						.duration( 500 )
						.ease( d3.easeBackOut )
						.attr( "transform", "translate( 275, 127.5)scale( " + ( eyeLeft ? 1 : -1 ) + ", 1 )")
				})
				.on( "mousedown", function(){
					d3.select( this )
						.transition()
						.duration( 1000 )
						.ease( d3.easeBackInOut )
						.attr( "transform", "translate( 275, 127.5)scale( " + ( eyeLeft ? -1 : 1 ) + ", 1 )")
					eyeLeft = !eyeLeft
				})

			d3.selectAll( "#NMbonds" )
				.on( "mouseover", function(){
					d3.select( this )
						.transition()
						.duration( 500 )
						.ease( d3.easeBackOut )
						.attr( "transform", "translate( 275, 127.5)rotate( " + ( rotated ? 190 : 10 ) + " )")
				})
				.on( "mouseout", function(){
					d3.select( this )
						.transition()
						.duration( 500 )
						.ease( d3.easeBackOut )
						.attr( "transform", "translate( 275, 127.5)rotate( " + ( rotated ? 180 : 0 ) + " )")
				})
				.on( "mousedown", function(){
					d3.select( this )
						.transition()
						.duration( 1000 )
						.ease( d3.easeBackInOut )
						.attr( "transform", "translate( 275, 127.5)rotate( " + ( rotated ? 0 : 180 ) + " )")
					rotated = !rotated
				})


			//////Focus camera on root atom//////
			var controlsStart = mol3d.controls.target;
			d3.transition()
				.duration( 2000 )
				.tween( null, () => function( t ){
					if( mol3d.scene.getObjectByName( "1_4" ) ){
						mol3d.controls.target.copy( new THREE.Vector3( ).copy( controlsStart ).lerp( new THREE.Vector3().copy( mol3d.scene.getObjectByName( "1_4" ).getWorldPosition() ), t ) );
					}
				} )


		}

		self.runGame2 = function(){

			if( d3.select( "#NewmanModel" ).empty() ){
				d3.select( "#gameFrame" ).append( "div" ).attr( "id", "NewmanModel" ).html(`
					<svg viewBox="0,0,480,321">
						<g class="dd" transform="translate( 240, 160 )rotate( 0 )">
							<circle cx="0" cy="0" r="50" style="stroke:black; fill:none;"></circle>
							<line x1="0" y1="0" x2="0" y2="-100"></line>
							<line x1="0" y1="0" x2="87" y2="50"></line>
							<line x1="0" y1="0" x2="-87" y2="50"></line>
							<line x1="43" y1="-25" x2="87" y2="-50"></line>
							<line x1="0" y1="50" x2="0" y2="100"></line>
							<line x1="-43" y1="-25" x2="-87" y2="-50"></line>
						</g>
						<g class="dd" transform="translate( 0, 40 )scale( 1 )">
							<text id="model1" x="240" y="5" style="cursor: unset"></text>
							<text id="model2" x="367" y="85" style="cursor: unset"></text>
							<text id="model3" x="367" y="195" style="cursor: unset"></text>
							<text id="model4" x="240" y="265" style="cursor: unset"></text>
							<text id="model5" x="113" y="195" style="cursor: unset"></text>
							<text id="model6" x="100" y="85" style="cursor: unset"></text
						</g>
					</svg>`
				)

				d3.select( "#NewmanModel > svg" )
					.append( "g" )
					.attr( "class", "eye" )
					.attr( "transform", "translate( 240, 160 )")
					.html(`
						<line x1="-170" x2="-150" y1="0" y2="20"></line>
						<line x1="-170" x2="-150" y1="0" y2="-20"></line>
						<path d="M -158 -12 Q -150 0 -158 12"></path>
						<line x1="-154" x2="-50" y1="0" y2="0" opacity="0.3" style="stroke-dasharray: 10px;"></line>
					`)
			} else{
				d3.select( ".eye" )
					.transition()
					.duration( 1000 )
					.attr( "transform", [1,3].indexOf( pathway ) === -1 ? "translate( 240, 160 )scale( -1, 1 )" : "translate( 240, 160 )scale( 1, 1 )" )
			}

			d3.select( "#NewmanModel > svg > .dd" )
				.transition()
				.duration( 1000 )
				.ease( d3.easeBackInOut )
				.attr( "transform", pathway > 2 ? "translate( 240, 160 )rotate( 180 )" : "translate( 240, 160 )rotate( 0 )");

			switch( pathway ){
				case 1:

					d3.select( "#NMdragdrop > #rootframe" ).attr( "transform", "translate( -10, 300 )rotate( -30 )scale( 2, -2 )" );
					d3.select( "#dd1_TAR" ).attr( "x", 345  ).attr( "y", 20 );
					d3.select( "#dd2_TAR" ).attr( "x", 145 ).attr( "y", 30 );
					d3.select( "#dd3_TAR" ).attr( "x", 335  ).attr( "y", 195 );
					d3.select( "#dd4_TAR" ).attr( "x", 135 ).attr( "y", 210 );
					d3.select( "#dd5_TAR" ).attr( "x", 355 ).attr( "y", 113 );
					d3.select( "#dd6_TAR" ).attr( "x", 235 ).attr( "y", 55 );
					break;

				case 2:

					d3.select( "#dd1_TAR" ).attr( "x", 105 ).attr( "y", 40 );
					d3.select( "#dd2_TAR" ).attr( "x", 355 ).attr( "y", 116 );
					d3.select( "#dd3_TAR" ).attr( "x", 240 ).attr( "y", 175 );
					d3.select( "#dd4_TAR" ).attr( "x", 360 ).attr( "y", 190 );
					d3.select( "#dd5_TAR" ).attr( "x", 140 ).attr( "y", 195 );
					d3.select( "#dd6_TAR" ).attr( "x", 330 ).attr( "y", 35 );
					break;

				case 3:

					d3.select( "#dd1_TAR" ).attr( "x", 105 ).attr( "y", 40 );
					d3.select( "#dd2_TAR" ).attr( "x", 330 ).attr( "y", 35 );
					d3.select( "#dd3_TAR" ).attr( "x", 140 ).attr( "y", 200 );
					d3.select( "#dd4_TAR" ).attr( "x", 360 ).attr( "y", 190 );
					d3.select( "#dd5_TAR" ).attr( "x", 230 ).attr( "y", 175 );
					d3.select( "#dd6_TAR" ).attr( "x", 350 ).attr( "y", 116 );
					break;

				case 4:

					d3.select( "#NMdragdrop > #rootframe" ).attr( "transform", "translate( -10, 300 )rotate( -30 )scale( 2, -2 )" );
					d3.select( "#dd1_TAR" ).attr( "x", 345 ).attr( "y", 20 );
					d3.select( "#dd2_TAR" ).attr( "x", 240 ).attr( "y", 55 );
					d3.select( "#dd3_TAR" ).attr( "x", 360 ).attr( "y", 114 );
					d3.select( "#dd4_TAR" ).attr( "x", 135 ).attr( "y", 210 );
					d3.select( "#dd5_TAR" ).attr( "x", 330 ).attr( "y", 195 );
					d3.select( "#dd6_TAR" ).attr( "x", 135 ).attr( "y", 30 );
					break;
			}

			shuffle( groups ).forEach(function( group, i ){
				d3.select( "#dd" + ( i + 1 ) ).text( group );
			})
			groups.forEach(function( group, i ){
				d3.select( "#model" + ( i + 1 ) ).text( group )
			})

		}

		self.closeGame = function(){

			self.reset();
			d3.select( "#NewmanModel" ).remove();

			d3.transition()
				.duration( 1500 )
				.tween( null, function(){ return function( t ){ mol3d.controls.target.lerp( new THREE.Vector3( 0, 0, 0 ), t ) } })

			mol3d.interactions( false );
			mol3d.autoRotate( true );
			mol3d.highlightSync( false );
			mol3d.highlight( false );
			mol3d.parse( intromolfile )
			mol3d.draw()

			//////FRAME REPOSITIONING//////
			d3.selectAll( ".view2D" )
				.transition()
				.duration( 1500 )
				.style( "width", "0px" )
				.style( "height", "0px" )
			d3.select( ".view3D" )
				.transition()
				.duration( 1500 )
				.style( "width", "1020px" )
				.style( "height", "431px" )
				.tween( null, function(){return function( t ){ mol3d.onWindowResize() } })
			d3.selectAll( ".menu" )
				.transition()
				.duration( 1000 )
				.ease( d3.easePolyInOut )
				.style( "top", "431px" )
			//////----------//////
		}

		self.submit = function(){

			var correct = [false,false,false,false,false,false];

			d3.selectAll( "#NMdragdrop > text" ).each( function( rank, i ){
				if( groups[ rank-1 ] === this.innerHTML ){
					correct[rank-1] = true
				} else{
				}
			} )

			if( self.mode === 1 ){
				switch( pathway ){
					case 1:
						correct = correct === true ? !rotated && eyeLeft : false
						break;

					case 2:
					correct = correct === true ? !rotated && eyeLeft : false
					break;

					case 3:
					correct = correct === true ? !rotated && eyeLeft : false
					break;

					case 4:
					correct = correct === true ? !rotated && eyeLeft : false
					break;

				}
			}

			correct.forEach( ( el, i ) => elFlash( d3.select( document.querySelectorAll( "#NMdragdrop > rect" )[i] ), el ) )
			if( correct.indexOf( false ) === -1 ){
				d3.select( "#NMinputs > .buttons > :nth-child(2)" ).transition()
					.delay( 300 )
					.duration( 300 )
					.style( "transform", "scale( 1.5 )" )
					.style( "background-color", "#4caf50" )
					.on( "end", function(){
						this.innerHTML = "Next";
						this.setAttribute( "onclick", "nm.init( true )" )
					} )
					.transition()
						.style( "transform", "scale( 1 )" )
				d3.select( "#NMinputs > .buttons > p" ).empty() && d3.select( "#NMinputs > .buttons" ).append( "p" ).attr( "class", "resultRight" ).html( "That's right!" )
			}

		}

		self.orient = function( eclipse ){
			var centre = d3.select( "#NMdragdrop > circle" );
			//d3.selectAll( "#NMdragdrop > [back]" ).attr( "back", eclipse ? "true" : "false" )
			var angleOffset = - Math.PI/3.5
			var positions = eclipse ?
				[
					[ 100 * Math.sin( 0 ), -100 * Math.cos( 0 ), -35, 0 ],
					[ 100 * Math.sin( Math.PI/3 * 2 ), -100 * Math.cos( Math.PI/3 * 2 ), 30, -15 ],
					[ 100 * Math.sin( Math.PI/3 * 4 ), -100 * Math.cos( Math.PI/3 * 4 ), 20, 15 ],
					[ 100 * Math.sin( angleOffset + Math.PI/3 ), -100 * Math.cos( angleOffset + Math.PI/3 ), 35, 0 ],
					[ 100 * Math.sin( angleOffset + Math.PI/3 * 3 ), -100 * Math.cos( angleOffset + Math.PI/3 * 3 ), -20, 15 ],
					[ 100 * Math.sin( angleOffset + Math.PI/3 * 5 ), -100 * Math.cos( angleOffset + Math.PI/3 * 5 ), -25, -15 ]
				] :
				[
					[ 100 * Math.sin( 0 ), -100 * Math.cos( 0 ), 0, 0 ],
					[ 100 * Math.sin( Math.PI/3 * 2 ), -100 * Math.cos( Math.PI/3 * 2 ), 0, 0 ],
					[ 100 * Math.sin( Math.PI/3 * 4 ), -100 * Math.cos( Math.PI/3 * 4 ), 0, 0 ],
					[ 100 * Math.sin( Math.PI/3 ), -100 * Math.cos( Math.PI/3 ), 0, 0 ],
					[ 100 * Math.sin( Math.PI/3 * 3 ), -100 * Math.cos( Math.PI/3 * 3 ), 0, 0 ],
					[ 100 * Math.sin( Math.PI/3 * 5 ), -100 * Math.cos( Math.PI/3 * 5 ), 0, 0 ]
				]

			d3.selectAll( "#NMdragdrop > text" ).each( function ( d, i ){
				if( d ){
					d3.select( this ).transition()
						.duration( 200 )
						.ease( d3.easeBackInOut )
						.attr( "x", +centre.attr( "cx" ) + positions[d-1][0] + positions[d-1][2] )
						.attr( "y", +centre.attr( "cy" ) + positions[d-1][1] + 13 + positions[d-1][3] )
				}
			})
			d3.selectAll( "#NMdragdrop > line" ).each( function( d, i ){
				d3.select( this ).transition()
					.duration( 200 )
					.ease( d3.easeBackInOut )
					.attr( "x1", +centre.attr( "cx" ) + ( i > 2 ? positions[i][0]*0.5 : 0 ) )
					.attr( "x2", +centre.attr( "cx" ) + positions[i][0] )
					.attr( "y1", +centre.attr( "cy" ) + ( i > 2 ? positions[i][1]*0.5 : 0 ) )
					.attr( "y2", +centre.attr( "cy" ) + positions[i][1] )
			});
			d3.selectAll( "#NMdragdrop > rect" ).each( function( d, i ){
				d3.select( this ).transition()
					.duration( 200 )
					.ease( d3.easeBackInOut )
					.attr( "x", +centre.attr( "cx" ) + positions[i][0] - 40 + positions[i][2] )
					.attr( "y", +centre.attr( "cy" ) + positions[i][1] - 20 + positions[i][3] )
			});

		}

		self.init();
	}

	function dragLabel( el ){
		evt = d3.event;
		evt.stopPropagation();

		var start = [ el.getAttribute( "x" ), el.getAttribute( "y" ) ];
		var downPos = evt.type === "touchstart" ? [ evt.changedTouches[0].clientX, evt.changedTouches[0].clientY ] : [ evt.clientX, evt.clientY ];
		var drag = ( evt ) => {
				evt.preventDefault();
				evt.stopPropagation();

				var delta = [ downPos[0] - ( evt.type === "touchmove" ? evt.changedTouches[0].clientX : evt.clientX ), downPos[1] - ( evt.type === "touchmove" ? evt.changedTouches[0].clientY : evt.clientY ) ];
				d3.select( el ).attr( "x", + start[0] - delta[0] );
				d3.select( el ).attr( "y", + start[1] - delta[1] );
		}
		var drop = ( evt ) => {
				evt.preventDefault();
				evt.stopPropagation();

				var svg = el.parentNode;
				var upPos = evt.type === "touchend" ? [ evt.changedTouches[0].clientX, evt.changedTouches[0].clientY ] : [ evt.clientX, evt.clientY ];
				var hitNode = null;
				d3.selectAll( "#" + el.parentNode.getAttribute( "id" ) + " > rect" ).each( function(){
					var bBox = this.getBoundingClientRect();
					if( upPos[0] > bBox.left && upPos[0] < bBox.right && upPos[1] < bBox.bottom && upPos[1] > bBox.top && this.getAttribute( "disabled" ) !== "true" ){
						hitNode = this;
					}
				})
				if( hitNode ){
					d3.select( el ).transition()
						.duration( 500 )
						.attr( "x", +hitNode.getAttribute( "x" ) + hitNode.getBoundingClientRect().width/2 )
						.attr( "y", +hitNode.getAttribute( "y" ) + hitNode.getBoundingClientRect().height/2 + 13 )
					d3.selectAll( "#" + svg.getAttribute( "id" ) + " > text" ).each( function( e ){
						if( e === hitNode.getAttribute( "id" ).substr( 2, 1 ) && el !== this ){
							d3.select( this ).transition()
								.duration( 500 )
								.attr( "x", start[0] )
								.attr( "y", start[1] )
							d3.select( this ).datum( d3.select( el ).datum() || null )
						}
					});

					d3.select( el ).datum( hitNode.getAttribute( "id" ).substr( 2, 1 ) );
				} else{
					d3.select( el ).attr( "x", start[0] );
					d3.select( el ).attr( "y", start[1] );
				}

				window.removeEventListener( "mousemove", drag )
				window.removeEventListener( "touchmove", drag )
				window.removeEventListener( "mouseup", drop )
				window.removeEventListener( "touchend", drop )

		}

		window.addEventListener( "mousemove", drag );
		window.addEventListener( "touchmove", drag, {passive: false} );
		window.addEventListener( "mouseup", drop );
		window.addEventListener( "touchend", drop, {passive: false} );


	}



/*	mol2d = new Mol2D( d3.select( "#R" ), [0,0,250,250] );
	mol2d.parse( molfile2d );
	mol2d.draw();
	mol3d = new Mol3D( d3.select("#L") );
	mol3d.parse( molfile3d );
	mol3d.draw()
	mol3d.showfGroups( false );

	//////ROTATE BONDS ON CLICK//////
	mol3d.onMouseDown = function( ){
		const down = [d3.event.clientX, d3.event.clientY, d3.event.buttons];

		d3.select(this).on( 'mouseup', function(){
			if( down[0] === d3.event.clientX && down[1] === d3.event.clientY){
				var raycaster = new THREE.Raycaster();
				raycaster.setFromCamera( mol3d.mouse, mol3d.camActive );
				var intersects = raycaster.intersectObjects( mol3d.scene.children, true );

				if( intersects.length > 0 ){
					console.log( intersects[0].object )
					switch( intersects[0].object.userData.type ){
						case "bond":

							d3.select(this).on( 'mousedown', null );
							d3.select(this).on( 'mouseup', null );

							var last_t = 0;
							var axis = new THREE.Vector3( ...intersects[0].object.userData.source.end.pos ).sub( new THREE.Vector3( ...intersects[0].object.userData.source.start.pos ) ).normalize();
							d3.transition()
								.duration(1000)
								.ease(d3.easeBackInOut)
								.tween(null, function(){
										return function( t ) {
											intersects[0].object.rotateOnWorldAxis ( axis , ( down[2] === 1 ? 1 : -1 )*(t - last_t)*Math.PI/4 )
											last_t = t
										};
								})
								.on( 'end', function(){ d3.select( mol3d.renderer.domElement ).on( 'mousedown', mol3d.onMouseDown, true) } );
							break;

						case "fGroup":

							console.log( intersects[0].object.userData.tooltip )
							break;

					}
				}

			}
			d3.select( mol3d.renderer.domElement ).on( 'mouseup', null );
		}, true);
	}
	d3.select( mol3d.container ).on( 'mousedown', mol3d.onMouseDown, true);*/
	</script>
</body>
